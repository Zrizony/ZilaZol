generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Retailer {
  id        Int             @id @default(autoincrement())
  name      String
  slug      String          @unique
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  isActive  Boolean         @default(true)
  needCreds Boolean?        @default(false)
  prices    PriceSnapshot[]
  stores    Store[]

  @@map("retailers")
}

model Store {
  id         Int             @id @default(autoincrement())
  retailerId Int
  name       String?
  city       String?
  externalId String
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  address    String?
  prices     PriceSnapshot[]
  retailer   Retailer        @relation(fields: [retailerId], references: [id], onDelete: Cascade)

  @@unique([retailerId, externalId])
  @@map("stores")
}

model Product {
  id         Int             @id @default(autoincrement())
  barcode    String          @unique
  name       String?
  brand      String?
  unit       String?
  category   String?
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  isWeighted Boolean         @default(false)
  quantity   Float?
  imageUrl   String?
  prices     PriceSnapshot[]

  @@map("products")
}

model PriceSnapshot {
  id         Int      @id @default(autoincrement())
  productId  Int
  retailerId Int
  storeId    Int?
  price      Float
  currency   String   @default("ILS")
  isOnSale   Boolean  @default(false)
  timestamp  DateTime
  seenAt     DateTime @default(now())
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  retailer   Retailer @relation(fields: [retailerId], references: [id], onDelete: Cascade)
  store      Store?   @relation(fields: [storeId], references: [id])

  @@index([productId, storeId])
  @@index([timestamp])
  @@map("price_snapshots")
}
